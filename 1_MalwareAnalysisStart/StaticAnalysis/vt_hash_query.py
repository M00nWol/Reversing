import urllib
import urllib.request
import json
import sys
import urllib.response


hash_value = sys.argv[1]
vt_url = "https://www.virustotal.com/vtapi/v2/file/report"
api_key = "{f70e0b7c6692c1664379bcda3d5e7d1d1c9b4674c2e556fc0858aa7604fac1fd}"
parameters = {'apikey': api_key, 'resource': hash_value}
encoded_parameters = urllib.parse.urlencode(parameters).encode('utf-8')
request = urllib.request.Request(vt_url, data = encoded_parameters)
response = urllib.request.urlopen(request)

json_response = json.loads(response.read())

output_file = "results/virustotal_report.txt"

with open(output_file, "w") as file:
    if json_response['response_code']:
        detections = json_response['positives']
        total = json_response['total']
        scan_results = json_response['scans']

        print("Detections: %s/%s" % (detections, total))
        file.write("Detections: %s/%s\n" % (detections, total))


        print("VirusTotal Results:")
        file.write("VirusTotal Results:\n")


        for av_name, av_data in scan_results.items():
            print("\t%s ==> %s" % (av_name, av_data['result']))
            file.write("\t%s ==> %s\n" % (av_name, av_data['result']))

    else:
        print("No AV Detections For: %s" % hash_value)
        file.write("No AV Detections For: %s\n" % hash_value)


